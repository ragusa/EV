Rearranging the continuity equation, substituting the approximate FEM
solution and testing with a test function $\testfunction_i^\height$ gives its
weak form for degree of freedom $i$:
\begin{equation}
  \intdomain{\testfunction_i^\height\ppt{\tilde{\height}}}
  = - \intdomain{\testfunction_i^\height\nabla\cdot\tilde{\heightmomentum}}
  \eqp
\end{equation}
Integrating by parts gives
\begin{equation}\label{eq:shallowwater_height_weak_form}
  \intdomain{\testfunction_i^\height\ppt{\tilde{\height}}}
  = \intdomain{\nabla\testfunction_i^\height\cdot\tilde{\heightmomentum}}
  - \intboundary{\testfunction_i^\height\tilde{\heightmomentum}\cdot\normalvector}
  \eqp
\end{equation}
Rearranging the $x$-momentum equation, substituting the approximate FEM solution
and testing with a test function $\testfunction_i^{\heightmomentumx}$
gives its weak form for degree of freedom $i$:
\begin{multline}
  \intdomain{\testfunction_i^{\heightmomentumx}\ppt{\tilde{\heightmomentumx}}}
  =
  - \intdomain{\testfunction_i^{\heightmomentumx}
      \pd{}{x}\pr{\frac{\tilde{\heightmomentumx}^2}{\height}
      + \frac{1}{2}\gravity\tilde{\height}^2}}
  \\
  - \intdomain{\testfunction_i^{\heightmomentumx}
      \pd{}{y}\pr{\frac{\tilde{\heightmomentumx}\tilde{\heightmomentumy}}
        {\height}}}
  - \intdomain{\testfunction_i^{\heightmomentumx}
      \gravity\tilde{\height}\pd{\bathymetry}{x}}
  \eqp
\end{multline}
Integrating by parts for the flux terms gives
\begin{multline}\label{eq:shallowwater_momentumx_weak_form}
  \intdomain{\testfunction_i^{\heightmomentumx}\ppt{\tilde{\heightmomentumx}}}
  =
    \intdomain{\pd{\testfunction_i^{\heightmomentumx}}{x}
      \pr{\frac{\tilde{\heightmomentumx}^2}{\height}
      + \frac{1}{2}\gravity\tilde{\height}^2}}
  - \intboundary{\testfunction_i^{\heightmomentumx}
      \pr{\frac{\tilde{\heightmomentumx}^2}{\height}
      + \frac{1}{2}\gravity\tilde{\height}^2}\normalx}
  \\
  + \intdomain{\pd{\testfunction_i^{\heightmomentumx}}{y}
      \frac{\tilde{\heightmomentumx}\tilde{\heightmomentumy}}
        {\height}}
  - \intboundary{\testfunction_i^{\heightmomentumx}
      \frac{\tilde{\heightmomentumx}\tilde{\heightmomentumy}}
        {\height}\normaly}
  - \intdomain{\testfunction_i^{\heightmomentumx}
      \gravity\tilde{\height}\pd{\bathymetry}{x}}
  \eqp
\end{multline}
Applying the same procedure to the $y$-momentum equation gives
\begin{multline}
  \intdomain{\testfunction_i^{\heightmomentumy}\ppt{\tilde{\heightmomentumy}}}
  =
    \intdomain{\pd{\testfunction_i^{\heightmomentumy}}{x}
      \frac{\tilde{\heightmomentumx}\tilde{\heightmomentumy}}{\height}}
  - \intboundary{\testfunction_i^{\heightmomentumy}
      \frac{\tilde{\heightmomentumx}\tilde{\heightmomentumy}}{\height}\normalx}
  \\
  + \intdomain{\pd{\testfunction_i^{\heightmomentumy}}{y}
      \pr{\frac{\tilde{\heightmomentumy}^2}{\height}
      + \frac{1}{2}\gravity\tilde{\height}^2}}
  - \intboundary{\testfunction_i^{\heightmomentumy}
      \pr{\frac{\tilde{\heightmomentumy}^2}{\height}
      + \frac{1}{2}\gravity\tilde{\height}^2}\normaly}
  - \intdomain{\testfunction_i^{\heightmomentumx}
      \gravity\tilde{\height}\pd{\bathymetry}{x}}
  \eqp
\end{multline}
In a more compact format, these two equations may be expressed as
\begin{multline}
  \intdomain{\testfunction_i^{\heightmomentum}\cdot\ppt{\tilde{\heightmomentum}}}
  = \intdomain{\nabla\testfunction_i^{\heightmomentum}:
    \left(\tilde{\heightmomentum}\otimes\tilde{\velocity}
    + \frac{1}{2}\gravity\tilde{\height}^2\mathbf{I}\right)}
  \\
  - \intboundary{\testfunction_i^{\heightmomentum}\cdot
    \left(\tilde{\heightmomentum}\otimes\tilde{\velocity}
    + \frac{1}{2}\gravity \tilde{\height}^2\mathbf{I}\right)\cdot\normalvector}
  - \intdomain{\testfunction_i^{\heightmomentum}\cdot
    \gravity\tilde{\height}\nabla\bathymetry}
  \eqp
\end{multline}
This yields a discrete system
\begin{equation}
  \consistentmassmatrix\ddt{\solutionvector} = \ssres \eqc
\end{equation}
where $\consistentmassmatrix$ is the mass matrix and the steady-state residual
$\ssres$ is given by
\begin{multline}
  r_i =
  \intdomain{\nabla\testfunction_i^\height\cdot\tilde{\heightmomentum}}
  - \intboundary{\testfunction_i^\height\tilde{\heightmomentum}\cdot\normalvector}
  + \intdomain{\nabla\testfunction_i^{\heightmomentum}:
    \left(\tilde{\heightmomentum}\otimes\tilde{\velocity}
    + \frac{1}{2}\gravity\tilde{\height}^2\mathbf{I}\right)}
  \\
  - \intboundary{\testfunction_i^{\heightmomentum}\cdot
    \left(\tilde{\heightmomentum}\otimes\tilde{\velocity}
    + \frac{1}{2}\gravity \tilde{\height}^2\mathbf{I}\right)\cdot\normalvector}
  - \intdomain{\testfunction_i^{\heightmomentum}\cdot
    \gravity\tilde{\height}\nabla\bathymetry}
\end{multline}
