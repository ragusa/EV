Recall from Section \ref{sec:shallowwater} the definition of the shallow
water equations:
\begin{equation}
\begin{gathered}
  \ppt{\vectorsolution} + \nabla\cdot\consfluxvector
  = \conssource \eqc
\\
  \vectorsolution
    = \left[\begin{array}{c}\height\\\heightmomentum\end{array}\right]
  \eqc\quad
  \consfluxvector
  = \left[\begin{array}{c}\heightmomentum\\
    \heightmomentum\otimes\velocity + \half\gravity\height^2\identity
    \end{array}\right]
  \eqc\quad
  \conssource
  = \left[\begin{array}{c}0\\-\gravity\height\nabla\bathymetry\end{array}
    \right] \eqp
\end{gathered}
\end{equation}
In this section, the following notation will be used to denote the fluxes
for each component:
\[
  \consfluxvector
  = \left[\begin{array}{c}
    \mathbf{\consfluxletter}^\height(\vectorsolution)\\
    \mathbf{\consfluxletter}^\heightmomentum(\vectorsolution)
    \end{array}\right]
  = \left[\begin{array}{c}\heightmomentum\\
    \heightmomentum\otimes\velocity + \half\gravity\height^2\identity
    \end{array}\right] \eqc
\]
where $\mathbf{\consfluxletter}^\heightmomentum(\vectorsolution)$ is a vector
of the momentum component fluxes:
\[
  \mathbf{\consfluxletter}^\heightmomentum(\vectorsolution)
  = \left[\begin{array}{c}
    \mathbf{\consfluxletter}^{\heightmomentumx}(\vectorsolution)\\
    \mathbf{\consfluxletter}^{\heightmomentumy}(\vectorsolution)
    \end{array}\right]
  = \left[\begin{array}{c c}
    \frac{\heightmomentumx^2}{\height} + \half\gravity\height^2
      & \frac{\heightmomentumx\heightmomentumy}{\height}\\
    \frac{\heightmomentumx\heightmomentumy}{\height}
      & \frac{\heightmomentumy^2}{\height} + \half\gravity\height^2\\
    \end{array}\right] \eqp
\]
In this section the dependence of the flux functions on $\vectorsolution$
will be dropped for brevity.
The entropy function for the shallow water equations is defined to be
the sum of the kinetic and potential ``energy'' terms, in terms of the
conservative variables:
\begin{equation}
  \entropy(\vectorsolution) = \half\frac{\heightmomentum\cdot\heightmomentum}
  {\height} + \half\gravity\height^2
  \eqp
\end{equation}
The objective here is to derive an entropy balance equation, which gives the
rate of change of entropy, $\partial_\timevalue\entropy$. To yield such an
equation, one can take advantage of the derivative chain rule:
\begin{equation}\label{eq:shallowwater_chainrule}
  \partial_\timevalue\entropy
  = \partial_\height\entropy\,\partial_\timevalue\height
  + \partial_\heightmomentum\entropy\cdot\partial_\timevalue\heightmomentum \eqc
\end{equation}
where the partial derivatives of the entropy function with respect to each
solution variable are the following:
\begin{subequations}
\begin{equation}
  \partial_\height\entropy
  = -\half\frac{\heightmomentum\cdot\heightmomentum}{\height^2}
  + \gravity\height \eqc
\end{equation}
\begin{equation}
  \partial_\heightmomentum\entropy
  = \sq{\begin{array}{c}
      \partial_{\heightmomentumx}\entropy\\
      \partial_{\heightmomentumy}\entropy
    \end{array}}
  = \sq{\begin{array}{c}
      \frac{\heightmomentumx}{\height}\\
      \frac{\heightmomentumy}{\height}
    \end{array}}
  = \frac{\heightmomentum}{\height} \eqp
\end{equation}
\end{subequations}
To arrive at an entropy equality, each conservation equation in the system
is multiplied by the respective derivative of the entropy function and then
summed:
\begin{equation}
  \highlightblue{\partial_\height\entropy\,\partial_\timevalue\height
  + \partial_\heightmomentum\entropy\cdot\partial_\timevalue\heightmomentum}
  + \highlightgreen{\partial_\height\entropy\,\divergence
    \mathbf{\consfluxletter}^\height
  + \partial_\heightmomentum\entropy\cdot\pr{\divergence 
    \mathbf{\consfluxletter}^\heightmomentum}
  + \partial_\heightmomentum\entropy\cdot\gravity\height\nabla\bathymetry}
  = 0 \eqc 
\end{equation}
where the terms highlighted in blue show the \emph{temporal} derivative terms
and the terms highlighted in green show the \emph{spatial} derivative terms.
Using Equation \eqref{eq:shallowwater_chainrule}, the temporal derivatives
can be expressed as a partial derivative of entropy:
\begin{equation}\label{eq:shallowwater_spatial_derivative_expanded}
  \highlightblue{\partial_\timevalue\entropy}
  + \highlightgreen{\partial_\height\entropy\,\divergence
    \mathbf{\consfluxletter}^\height
  + \partial_\heightmomentum\entropy\cdot\pr{\divergence
    \mathbf{\consfluxletter}^\heightmomentum}
  + \partial_\heightmomentum\entropy\cdot\gravity\height\nabla\bathymetry}
  = 0 \eqp
\end{equation}
An \emph{entropy flux} $\mathbf{\consfluxletter}^\entropy$, is defined such
that its divergence matches the spatial derivative terms in Equation
\eqref{eq:shallowwater_spatial_derivative_expanded}:
\begin{equation}\label{eq:shallowwater_entropy_equality}
  \highlightblue{\partial_\timevalue\entropy}
  + \highlightgreen{\divergence\mathbf{\consfluxletter}^\entropy}
  = 0 \eqp
\end{equation}
Comparing Equations \eqref{eq:shallowwater_spatial_derivative_expanded} and
\eqref{eq:shallowwater_entropy_equality} gives the definition of the
divergence of the entropy flux:
\begin{align}
  \nabla\cdot\mathbf{\consfluxletter}^\entropy
  &= 
    \partial_\height\entropy\,\divergence
    \mathbf{\consfluxletter}^\height
  + \partial_\heightmomentum\entropy\cdot
    \pr{\divergence\mathbf{\consfluxletter}^\heightmomentum}
  + \partial_\heightmomentum\entropy\cdot\gravity\height\nabla\bathymetry
  \nonumber\\
  \nabla\cdot\mathbf{\consfluxletter}^\entropy
  &= 
    \pr{-\half\frac{\heightmomentum\cdot\heightmomentum}{\height^2}
    + \gravity\height}
    \divergence\mathbf{\consfluxletter}^\height
    + \frac{\heightmomentum}{\height}\cdot
    \pr{\divergence\mathbf{\consfluxletter}^\heightmomentum}
    + \frac{\heightmomentum}{\height}\cdot\gravity\height\nabla\bathymetry
  \nonumber\\
  \nabla\cdot\mathbf{\consfluxletter}^\entropy
  &= 
    \pr{-\half\frac{\heightmomentum\cdot\heightmomentum}{\height^2}
    + \gravity\height}
    \divergence\heightmomentum
    + \frac{\heightmomentum}{\height}\cdot
    \pr{\frac{2\heightmomentum}{\height}\divergence\heightmomentum
    + \pr{\gravity\height\identity
    - \frac{\heightmomentum\otimes\heightmomentum}{\height^2}}\cdot\nabla\height}
    + \gravity\heightmomentum\cdot\nabla\bathymetry
  \nonumber\\\label{eq:shallowwater_divergence_coef}
  \nabla\cdot\mathbf{\consfluxletter}^\entropy
  &= 
    \pr{\frac{3}{2}\frac{\heightmomentum\cdot\heightmomentum}{\height^2}
    + \gravity\height}
    \divergence\heightmomentum
    + \pr{\gravity\heightmomentum
    - \frac{\heightmomentum\cdot(\heightmomentum\otimes\heightmomentum)}
    {\height^3}}\cdot\nabla\height
    + \gravity\heightmomentum\cdot\nabla\bathymetry
\end{align}
Assuming the entropy flux to be a function of $\height$, $\heightmomentum$,
and $\bathymetry$, i.e., the entropy flux is
$\mathbf{\consfluxletter}^\entropy(\height,\heightmomentum,\bathymetry)$,
and applying chain rule for its divergence yields
\begin{equation}
  \nabla\cdot\mathbf{\consfluxletter}^\entropy
  = \partial_\height\mathbf{\consfluxletter}^\entropy\cdot\nabla\height
  + \partial_\heightmomentum\mathbf{\consfluxletter}^\entropy
  \,\divergence\heightmomentum
  + \partial_\bathymetry\mathbf{\consfluxletter}^\entropy\cdot\nabla\bathymetry
  \eqp
\end{equation}
Matching the coefficients of $\nabla\height$, $\divergence\heightmomentum$,
and $\nabla\bathymetry$
between this equation and Equation \eqref{eq:shallowwater_divergence_coef}
gives the definitions of the partial derivatives of the entropy flux:
\begin{subequations}
\begin{equation}\label{eq:shallowwater_entropy_pd_height}
  \partial_\height\mathbf{\consfluxletter}^\entropy
  = \gravity\heightmomentum
  - \frac{\heightmomentum\cdot\pr{\heightmomentum\otimes\heightmomentum}} 
  {\height^3}
  \eqc
\end{equation}
\begin{equation}\label{eq:shallowwater_entropy_pd_momentum}
  \partial_\heightmomentum\mathbf{\consfluxletter}^\entropy
  = \frac{3}{2}\frac{\heightmomentum\cdot\heightmomentum}{\height^2}
  + \gravity\height \eqc
\end{equation}
\begin{equation}\label{eq:shallowwater_entropy_pd_bathymetry}
  \partial_\bathymetry\mathbf{\consfluxletter}^\entropy
  = \gravity\heightmomentum
  \eqp
\end{equation}
\end{subequations}
Integrating the equation for $\partial_\height\mathbf{\consfluxletter}^\entropy$
gives
\begin{equation}\label{eq:shallowwater_entropy_flux_with_constant}
  \mathbf{\consfluxletter}^\entropy
  = \gravity\heightmomentum\height
  + \half\frac{\heightmomentum\cdot\pr{\heightmomentum\otimes\heightmomentum}} 
  {\height^2}
  + c(\heightmomentum, \bathymetry) \eqc
\end{equation}
where $c(\heightmomentum, \bathymetry)$ is a constant with respect to $\height$.
Taking the partial derivative of this expression with respect to
$\heightmomentum$ gives
\begin{equation}
  \partial_\heightmomentum\mathbf{\consfluxletter}^\entropy
  = \frac{3}{2}\frac{\heightmomentum\cdot\heightmomentum}{\height^2}
  + \gravity\height + \pd{c}{\heightmomentum} \eqc
\end{equation}
which when compared to Equation \eqref{eq:shallowwater_entropy_pd_momentum}
gives $\partial_\heightmomentum c=0\Rightarrow c(\heightmomentum,\bathymetry)=
c(\bathymetry)$.
Then taking the partial derivative of Equation
\eqref{eq:shallowwater_entropy_flux_with_constant} with respect to $\bathymetry$
and using the knowledge $c(\heightmomentum,\bathymetry)\rightarrow c(\bathymetry)$
gives $\dd{c}{\bathymetry}=0\Rightarrow c(\bathymetry)=c$, where
$c$ can just be chosen to be zero. Thus the final equation for the
entropy flux is
\begin{equation}
  \mathbf{\consfluxletter}^\entropy(\vectorsolution,\bathymetry)
  = \gravity(\height + \bathymetry)\heightmomentum
  + \half\frac{\heightmomentum\cdot\pr{\heightmomentum\otimes\heightmomentum}} 
  {\height^2}
  \eqp
\end{equation}
The entropy residual is defined to be the left hand side of 
Equation \eqref{eq:shallowwater_entropy_equality}:
\begin{equation}
  \entropyresidual(\vectorsolution) \equiv \partial_\timevalue\entropy
  + \divergence\mathbf{\consfluxletter}^\entropy
  \eqp
\end{equation}
The entropy jump for a face $F$ is defined to be
\begin{multline}
  \entropyjump_F(\vectorsolution)
  \equiv \Bigg\|
    \partial_\height\entropy \, \partial_\height\mathbf{\consfluxletter}^\height
      \cdot\normalvector_F
      \jumpbrackets{\nabla\height \cdot \normalvector_F}
    + \sum\limits_{d=1}^{\ndimensions}\partial_{\heightmomentumletter_d}\entropy
      \, \partial_{\heightmomentumletter_d}\mathbf{\consfluxletter}
        ^{\heightmomentumletter_d} \cdot\normalvector_F
      \jumpbrackets{\nabla\heightmomentumletter_d \cdot \normalvector_F}
    \\
    + \sum\limits_{d=1}^{\ndimensions}\partial_{\heightmomentumletter_d}\entropy
        \, \gravity\height
      \jumpbrackets{\dd{\bathymetry}{x_d}\normalvectorletter_{F,d}}
  \Bigg\|_{L^\infty(F)} \eqp
\end{multline}
The regularization of the shallow water equations is achieved by adding
viscous fluxes:
\begin{equation}
\begin{gathered}
  \ppt{\vectorsolution} + \nabla\cdot\consfluxvector
  + \highlightgreen{\nabla\cdot\viscconsfluxvector}
  = \conssource \eqc
\\
  \viscconsfluxvector
  \equiv \left[\begin{array}{c}
    \viscflux{\height}(\vectorsolution,\viscosity)\\
    \viscflux{\heightmomentum}(\vectorsolution,\viscosity)
    \end{array}\right]
  \equiv \left[\begin{array}{c}
    \viscosity\nabla\height\\
    \viscosity\nabla\heightmomentum
    \end{array}\right] \eqc
\end{gathered}
\end{equation}
where $\viscosity$ is viscosity, which is computed as in Section
\ref{sec:entropy_viscosity_scalar}.
